\input{common/header.tex}
\inbpdocument

\chapter{Representing probability distributions of exchangeable databases and relational data}
\label{ch:arrays}

In chapter~\ref{ch:networks} we demonstrated how to characterise probability distributions over objects such as networks or user--item rating matrices.
The key properties that allowed us to characterise these distributions were symmetries in the data, or invariances to the way they are stored.
For networks, we assumed that the ordering of the nodes contained no information.
For user--item data we assumed that the order of both users and items were irrelevant to the meaning of the data.

In this chapter we extend these ideas of exchangeability to any data that can be stored in a relational database \ie arbitrary relational data.
We demonstrate that extensions of the Aldous--Hoover theorem to $n$-arrays due to Kallenberg \citep{Kallenberg1999-pj} can be extended to the case of exchangeable databases.
These new theorems reveal a natural parameter space for data stored in relational databases elucidating how to construct appropriate statistical models for such data.

This chapter is largely based on collaborations with Zoubin Ghahramani, Peter Orbanz and Daniel Roy.
In particular, the technical results presented in this chapter appeared at the Bayesian Nonparametrics Workshop 2012 and a NIPS workshop \citep{Lloyd_undated-iu} but without proof.

\section{Introduction}

Relational databases are an extremely common data structure so it is natural to want to perform statistical tasks with such data \eg predicting unobserved data or identifying latent structure.
In particular, network data is rarely encountered in isolation \eg in a social network one will often have access to side information about each user.
To perform a statistical analysis of such data we will typically need to specify a probabilistic model of the data, but it is not immediately clear what an appropriate parameter space for such a model is.
The choice of parameter space is important because it indicates the targets of statistical inference and determines where we can share statistical strength between different aspects of the data.

We demonstrate that the weak assumption of an appropriate form of exchangeability can provide a natural parameter space.
This form of exchangeability is appropriate when the order of the objects underlying a relational database (\eg users and movies in a database of ratings data) is arbitrary or unimportant.
For example, the left hand side of figure~\ref{fig:exchangeable} shows the same network but with differently labeled nodes.
If the labeling is unimportant, then any probabilistic model of such data should assign them the same probability.

\begin{figure}[t]
\centering
\begin{tabular}{c}
\tiny \input{\arraysfigsdir/exchangeable}
\end{tabular}
\caption{Left: Networks with equivalent structure but different node labels. Right: Corresponding adjacency matrix representations of these networks}
\label{fig:exchangeable}
\end{figure}

Relational data are typically stored in arrays; the right hand side of figure~\ref{fig:exchangeable} shows the corresponding adjacency matrix representations of the networks on the left.
We demonstrate that exchangeability of the objects underlying a relational database can be expressed in terms of array exchangeability.
Prior work on array exchangeability, both theoretical \citep[e.g.][]{Hoover1979-br, Aldous1981-lg, Hoover1982-ty, Kallenberg1999-pj, Diaconis2007-mi, Aldous2010-iw, Austin2012-jq, Choi2013-th, Wolfe2013-vs} and applied \citep[e.g.][]{Hoff2007-ja,Roy2009-ge,Lloyd2012-sb}, has focused on single exchangaeble arrays.
We show that the representation theorems for single arrays can be used to derive representations for collections of exchangeable arrays \ie exchangeable databases or exchangeable relational data.

\section{Exchangeable databases}

We abstractly define a database following the entity-relationship formalism \citep[e.g.][]{Ullman2002-eo} where the values of attributes are the result of evaluating functions (relations) over a collection of entities / objects.

\newcommand{\bi}{\bm{i}}
\newcommand{\Types}{T}
\newcommand{\Space}{S}
\begin{definition}[types, signatures, relation]
Fix a finite set $\Types$ of \defn{types}.  Define a \defn{signature} to be a finite sequence $s \in \Types^d$ of types.
Define a \defn{relation $r$ of signature $s \in \Types^d$ with values in a space $\Space$} to be a function from $\Nats^d$ to $\Space$.
\end{definition}

We may encode a relation $r$ with signature $s \in \Types^d$ as an array $X^r \defas (X^r_{\bi})_{\bi \in \Nats^d}$ given by
\[
X^r_{\bi} = r(i_1,\dotsc,i_d), \qquad \text{for } \bi = (i_1,\dotsc, i_d) \in \Nats^d.
\]

\begin{example} 
Let $\Types = \{\textit{users,movies}\}$.
A relation $r$ of signature $(\textit{users},\textit{movies})$ taking values in $\{1,2,3,4,5\}$ might record movie ratings.
This could be stored in an array, with rows corresponding to some enumeration of \textit{users}, and columns corresponding to some enumeration of \textit{movies}. 
A relation $r'$ of signature $(\textit{users},\textit{users})$ taking values in $\{0,1\}$ might store the symmetric friendship relations in a social network.
\end{example}

\begin{definition}[database]
Define a \defn{database} to be a collection of $R$ relations $r_1,\dotsc,r_R$ of signature $s_1,\dotsc,s_R$, taking values in spaces $\Space_1,\dotsc,\Space_R$, respectively.
\end{definition}

We may encode a database as a collection of arrays $(X^{r_j})_{j=1}^R$, where $X^{r_j}$ encodes the relation $r_j$.  
For notational simplicity, we will often refer to the collection of arrays $(X^{r_j})_{j=1}^R$ as if it were the database itself.

Permuting the ordering of objects within a database results in a permutation of the indices of several of the arrays encoding its relations.
For each type $t \in \Types$, let $p_t \in \SGinf$ be a permutation of $\Nats$. 
Write $p = (p_t ; t \in \Types) \in \SGinf^T$ for the collection of such permutations.
Given a signature $s \in \Types^d$, define $p^s$ to be the map from $\Nats^d$ to $\Nats^d$ such that
\[
p^s(\bi) \defas (p_{s_1}(i_1), \dotsc,p_{s_d}(i_d)), \qquad \text{for } \bi \in \Nats^d.
\]
In other words, $p^s$ maps a sequence $i_1,\dotsc,i_d$ of indices (indexing objects of type $s_1,\dotsc,s_d$, respectively) to the sequence where each index is permuted by the permutation corresponding to its type.

If $X^r$ is the encoding of a relation $r$ with signature $s \in \Types^d$, then the permuted relation $r \circ p$ is represented by the array $X^{r\circ p}$ given by
\[
X^{r \circ p}_{\bi} = X^r_{p^s(\bi)}, \qquad \text{for } \bi \in \Nats^d.
\]

\begin{definition}[exchangeable database]
We say that a random database $(X^{r_j})_{j=1}^R$ is \emph{exchangeable} when it has the same distribution as $(X^{r_j\circ p})_{j=1}^R$ for every $p \in \SGinf^T$.
\end{definition}

%If the ordering of all objects is arbitrary, then $X^r$ is $\pi$-exchangeable where $\pi$ is the partition of consecutive integers with lengths $m^r_1, m^r_2, \ldots, m^r_O$.

%\PROBLEM{Here}

\subsection{A simplified representation theorem}

%Let $\Law(Y)$ be the law (distribution) of a random variable $Y$ and define $\chi_m X \defas (X_{i_1\ldots i_d}; \ i_j \le m )$.
The following result characterises the distribution of any exchangeable database to arbitrary accuracy.

\begin{cor}[functional representation for exchangeable databases]
  \label{cor:simple-database}
   Let $(X^{r_j})_{j=1}^R$ be an exchangeable random database.
   Then there exists a sequence of random measurable functions $F^{j,1}, F^{j,2}, \dotsc$ for 
   every $j=1\ldots R$ and collection of \iid Uniform$[0,1]$ random variables $(\AHvar^t_i)_{i\in\Nats,t \in \Types}$ such that 
   the random databases $(X^{r_j,n})_{j=1}^R$
    converge in distribution to $(X^{r_j})_{j=1\ldots R}$ as $n\to \infty$ on all finite subarrays, where   
   the sequence of arrays $X^{j,1},X^{j,2},\dotsc$, for $j \in \{1,\dotsc,R\}$ are given by
   \[
     X^{r_j,n}_{\bi} := F^{j,n}(\AHvar^{s_j(1)}_{i_1},\dotsc,\AHvar^{s_j(d)}_{i_d}), \qquad \text{for } \bi \in \Nats^d.
   \]
\end{cor}

This is a corollary of theorem~\ref{thm:simple-database} which states that the law of fixed subarrays are mutually absolutely continuous and the associated Radon-Nikodym derivatives converge uniformly to $1$ as $n \to \infty$.
We also present an almost-sure representational result which requires some heavy notation which we build up in subsequent sections.

To demonstrate this theorem, we present two special cases of this result applicable to modelling a network with side information for each node and a social network with associated user-item data.

\begin{cor}
  \label{cor:network-side-simple}
  Consider an exchangeable database with one object type, one unary relationship, and one binary relationship; denote the binary relationship by the array $X=(X_{i,j})_{i,j\in\Nats}$ and the unary relationship with the sequence $C=(C_i)_{i\in\Nats}$.
   Then there exists a sequence of pairs of random measurable functions $(F^n, G^n)_{n\in\Nats}$ and a collection of \iid Uniform$[0,1]$ random variables $(\AHvar_{i})_{i\in\Nats}$ such that if we define the arrays $X^1,X^2,\dotsc$ and sequences $C^1,C^2,\dotsc$ by
   \[ 
     X^n_{i,j} &\defas F^n(\AHvar_{i},\AHvar_{j}), \qquad \text{for } i,j,n\in\Nats, \\
     C^n_{i} &\defas G^n(\AHvar_{i}), \qquad \text{for } i,n\in\Nats,
    \]
   then $(X^n,C^n)$ converges in distribution to $(X,C)$ as $n \to \infty$ on all finite subarrays.
\end{cor}

\begin{cor}
  Consider an exchangeable database with two object types, one binary relation between two objects of the first type and a binary relation between objects of different types;  denote the first relation by the array $X=(X_{i,j})_{i,j\in\Nats}$ and the second by $Y=(Y_{i,k})_{i,k\in\Nats}$.
   Then there exists a sequence of pairs of random measurable functions $(F^n, G^n)_{n\in\Nats}$ and a collection of \iid Uniform$[0,1]$ random variables $(\AHvar_{i})_{i\in\Nats}, (\AHvaralt_{i})_{i\in\Nats}$ such that if we define the arrays $X^1,X^2,\dotsc$ and  $Y^1,Y^2,\dotsc$ by
   \[ 
     X^n_{i,j} &\defas F^n(\AHvar_{i},\AHvar_{j}), \qquad \text{for } i,j,n\in\Nats, \\
     Y^n_{i,k} &\defas G^n(\AHvar_{i}, \AHvaralt_{k}), \qquad \text{for } i,k,n\in\Nats,
    \]
   then $(X^n,Y^n)$ converges in distribution to $(X,Y)$ as $n \to \infty$ on all finite subarrays.
\end{cor}

%\begin{rem}[uniform distributions]\label{rem:uniform}
%The uniform distributions in the theorem are canonical but the theorem still holds with any non-atomic probability measure on a Borel space \eg Gaussian distributions.
%\end{rem}

\begin{rem}[random functions]\label{rem:randfunc}
  When we refer to a random function we mean a deterministic function which takes an additional source of randomness as input.
  For example $F(\textrm{arguments}) \defas f(U, \textrm{arguments})$ where $f$ is deterministic and $U$ is uniformly distributed would be an example of a random function.
\end{rem}

\subsection{Interpretation and examples}

Corollary~\ref{cor:simple-database} states that the joint distribution of an exchangeable database can be arbitrarily well approximated by a collection of random measurable functions and uniform random variables.
This functional form provides a set of parameters to be estimated that are naturally hierarchical.
The functions $(F^{j,n})$ capture properties of entire relations whilst the $(U^t_i)$ represent randomness associated with particular objects underlying the relational data.

\subsubsection{Example : Exchangeable networks}

Consider modeling a single binary relation which indicates whether or not two nodes in a network are connected or not.
This data is typically represented in the form of an adjacency matrix $(X_{ij})$ where $X_{ij} = 1$ if and only if node $i$ is connected to node $j$.
Theorem~\ref{thm:simple-database} states that if the distribution of $X$ is exchangeable then it can be arbitrarily well approximated by
\begin{equation}
(F(\AHvar_i, \AHvar_j))
\end{equation}
where $F$ is a random measurable function and $(U_i)$ are \iid Uniform$[0,1]$ random variables.
This special case was used previously by \cite{Hoff2007-ja,Roy2009-ge,Lloyd2012-sb} and in chapter~\ref{ch:networks} to inspire probabilistic models of networks of the form
\begin{eqnarray}
(\AHvar_i) & \simiid & \textrm{\eg Gaussian} \\
F & \sim & \textrm{\eg Gaussian process, bilinear function}\ldots \\
W_{ij} & := & F(\AHvar_i, \AHvar_j) \\
X_{ij} | W_{ij} & \sim & \textrm{Bernoulli}(\sigma(W_{ij}))\label{eq:graphon}.
\end{eqnarray}
This is demonstrated pictorially in figure~\ref{fig:graphon}; in this case $F$ can be interpreted as a blurred adjacency matrix.

\begin{figure}[ht]
\centering
\begin{tabular}{c}
\input{\arraysfigsdir/fig_graphon_wide}
\end{tabular}
\caption{
A pictorial representation of a model for network data inspired by the Aldous--Hover representation theorem.
The left shows a random sample of a binary network (represented by an adjacency matrix) generated by a model of the form given by equation~\eqref{eq:graphon}.
}
\label{fig:graphon}
\end{figure}

\subsubsection{Example : A simple database}

Consider the simple database shown on the left hand side of figure~\ref{fig:multi-rel-seq}.
There are two objects, students and courses, and three relations, the unary relation `age' acting on students, the binary relation `friends' acting on pairs of students and the binary relation `grade' that acts on students and courses.
Sample data encoded in arrays is shown at the bottom of this figure.

Exchangeability of this database means that the entries of the leftmost table, the rows and columns of the second table and the rows of the third table can be arbitrarily permuted without changing the distribution of the database when viewed as a random variable.
Similarly the columns of the rightmost table may be independently arbitrarily permuted.

The functional form resulting from the application of theorem~\ref{thm:simple-database} to this data structure is shown on the right hand side of figure~\ref{fig:multi-rel-seq}.
The two objects are represented by \iid random variables, $(U_i)$ for students, $(V_i)$ for courses and the three relations are represented by three random functions $F(\AHvar_i),G(\AHvar_i,\AHvar_j)$ and $H(\AHvar_i,\AHvaralt_j)$ whose inputs are the random variables representing the objects the relations act upon.

\begin{figure}[ht]
\centering
\begin{tabular}{cc}
\tiny \input{\arraysfigsdir/multi_rel_seq} & \tiny \input{\arraysfigsdir/multi_rel_seq_U_F}
\end{tabular}
\caption{Left: A pictorial representation of a relational database. Right: The functional representation of the distribution of data of this form guaranteed to be an arbitrarily good approximation by theorem~\ref{thm:simple-database}}
\label{fig:multi-rel-seq}
\end{figure}

\section{A representation theorem for exchangeable databases}
\label{sec:proof_database}

\subsection{Background: $\pi$-exchangeability}

This section reviews material from \citet{Kallenberg1999-pj}.
Let $\pi$ be a partition of the set $\{1,\dots,d\}$ and $p = \{p^{\pi_i} : i = 1,\dots,d\}$ be a collection of permutations of $\Nats$ where $\pi_i \defas \{I \in \pi : i \in I\}$.
We say that an array $X^r$ representing relation $r$ is $\pi$-exchangeable if 
\begin{equation}
  X^{r\circ p} \eqd X
\end{equation}
for all collections $p$ of permutations of $\Nats^d$ of the form given above.
Note that this is precisely the type of symmetry we defined for exchangeable databases.

We say that a $\pi$-exchangeable array $X$ is simple if it admits a functional representation of the form
\begin{equation}
  X_{\bi} = F(U, U^{\pi_1}_{\bi_1}, \dots, U^{\pi_d}_{\bi_d})
\end{equation}
where $F$ is a measurable function and $U, U^{\pi_j}_{\bi_j}$ are \iid Uniform$[0,1]$ random variables.

\begin{prop}[$\pi$-exchangeability representation theorem]
  \label{thm:piex}
  Let $X$ be a $\pi$-exchangeable array.
  Then there exist some simple $\pi$-exchangeable arrays $X_1$ , $X_2$ , \dots such that
  $\chi_m X_n$ and $\chi_m X$ are mutually absolutely continuous for all $m,n \in \Nats$ and the associated Radon--Nikodym derivatives tend
  uniformly to 1 as $n \to \infty$ for fixed $m$ where $\chi_m$ is the array subset operation such that $\chi_m Y \defas \{Y_{\bi} : \bi \in \{1,\dots,m\}^d\}$.
\end{prop}

\subsection{Simple exchangeable database representation theorem}

We say that an exchangeable database $(X^{r_j})_{j=1}^R$ is simple if it admits a functional representation of the form
\begin{equation}
  X^{r_j}_{\bi} = F^{r_j}(U, U^{s_{j}(1)}_{\bi_1},\dots,U^{s_{j}(d_j)}_{\bi_{d_j}}) \,\, \forall \,\, \bi \in \Nats^{d_j} \,\, \forall \,\, j \in {1,\dots,R}.
\end{equation}

We first state a simple but useful lemma.
It can be proven by writing down the definitions of Radon--Nikodym derivatives and uniform convergence.

\begin{lem}
  \label{lem:contractionrnd}
  Suppose that two sequences of random variables $(X^n)$ and $(Y^n)$ are such that $X^n$ and $Y^n$ are mutually absolutely continous for all $n$, and the associated Radon--Nikodym derivatives converge uniformly to 1.
  Then for any measurable $f$, $f(X^n)$ and $f(Y^n)$ are mutually absolutely continuous for all $n$ and the associated Radon--Nikodym derivatives converge uniformly to 1.
\end{lem}

We also build up some notation for a particular exchangeable database $(X^{r_j})_{j=1}^R$.
Assume w.l.o.g.\ that the types are ordered (\eg type 1, type 2,\dots) and the types in each signature respect this ordering (\eg $s = (1,1,2,3,3,\dots)$).
Define the multiplicity of a type $t$ in signature $s$ by the number of times the type appears in the signature, and denote this by $m_{t}^s$.
Define the maximum multiplicity of a type $t$ in a database as $m_t = \max_j m_t^{s_j}$.
Let $d = \sum_{t\in T} m_t$ be the sum of the maximum multiplicities.
Let $\pi$ be the partition of $\{1,\ldots,d\}$ consisting of consecutive blocks of integers with sizes equal to $\{m_1,\ldots,m_T\}$.
Let $\rho_j : \Nats^d \to \Nats^{d_j}$ be the projection that keeps the first $m_{1}^{s_j}$ dimensions, ignores the next $m_1 - m_{1}^{s_j}$, keeps the next $m_{2}^{s_j}$ et cetera.
Similarly, let $\tilde{\rho}_j : \Nats^d \to \Nats^d$ be analogous to $\rho_j$ except that the indices removed by $\rho_j$ are now set to the value 1.
Again similarly, for a signature $s$ let $I_s$ be the subset of $\{1,\ldots,d\}$ that contains the first $m_1^s$ integers and then not the next $m_1 - m_1^s$ integers, then the next $m_2^s$ integers, and then not the next $m_2 - m_2^s$ integers and so on.
Let $\mathbb{I}_s$ be the indicator function of the set $I_s$ within $\{1,\ldots,d\}$.
We can now state and prove the first main result of this chapter.

\begin{thm}[Simple exchangeable database representation theorem]
  \label{thm:simple-database}
  Let $(X^{r_j})_{j=1}^R$ be an exchangeable database.
  Then there exist some simple exchangeable databases $(X^{r_j,1})_{j=1}^R$ , $(X^{r_j,2})_{j=1}^R$ , \dots such that
  $\chi_m (X^{r_j,n})_{j=1}^R$ and $\chi_m (X^{r_j})_{j=1}^R$ are mutually ansolutely continuous for all $m,n \in \Nats$ and the associated Radon--Nikodym derivatives converge uniformly to 1 as $n \to \infty$ for fixed $m$.
\end{thm}

\begin{proof}
  We first embed all of the arrays representing the exchangeable database into one larger array:
  \[
    R_{\bi} = (X^{r_j}_{\rho(\bi)} : j = 1,\dots,R) \quad \forall \, \bi \in \Nats^d.
  \]
  By definition of an exchangeable database, this array is $\pi$ exchangeable where $\pi$ is as defined in the preceeding text.
  By proposition~\ref{thm:piex} there exists a sequence of measurable functions $(F^n)$ and collection of independent uniform random variables $U$ and $U^t_i$ such that $\chi_m R_{\bi}$ and $\chi_m F^n(U, U^{\pi_1}_{\bi_1}, \dots, U^{\pi_d}_{\bi_d})$ are mutually absolutely continuous and the associated Radon--Nikodym derivates converge uniformly to 1 as $n \to \infty$ for all $m$.
  By lemma~\ref{lem:contractionrnd} we have the same convergence for the following subarrays
  \[
    F^{n,j}(U, U^{\pi_1}_{\tilde{\rho}_j(\bi_1)}, \dots, U^{\pi_d}_{\tilde{\rho}_j(\bi_d)}) \to X^{r_j}_{\rho(\bi)}.
  \]
  By the Borel isomorphism theorem there is a bimeasurable function $H$ and a uniformly distributed random variable $V$ such that
  \[
    V = h(U, U^1_1, \dots, U^T_1)
  \]
  Let
  \[
    G^{n,j}(V, U^{\pi_k}_{\bi_k} : k \in I_{s_j}) \defas F^{n,j}(U, U^{\pi_1}_{\tilde{\rho}_j(\bi_1)}, \dots, U^{\pi_d}_{\tilde{\rho}_j(\bi_d)}).
  \]
  $G$ is measurable by composition of measurable $F$ and $H$.
  Finally set
  \[
    X^{r_j,n}_{\bi} \defas G^{n,j}(V, U^{\pi_k}_{\bi_k} : k \in I_{s_j})
  \]
  and we are done.
\end{proof}

\subsection{Almost sure exchangeable database representation theorem}

To prove an almost sure representation theorem for exchangeable databases we will require yet more notation; we follow Kallenberg except where we think changes may make it easier to understand.
However, there is only so much we have been able to do to reduce the notational burden so we provide corollaries of the theorem after its statement and proof to demonstrate that behind the notation are some fairly intuitive concepts.

We define for each $k \in \Nats^d$ and $I \subset \{1,\ldots,d\}$ a set $k_I \subset \Nats$ by
\begin{equation}
k_I = \{k_i: i \in I\}, \quad k \in \Nats^d
\end{equation}
\ie $k_I$ only includes the indices in $I$.

We further define $k_{\pi I}$ by
\begin{equation}
  k_{\pi I} = (k_{I \cap J} : J \in \pi)
\end{equation}
N.B. we have replaced Kallenberg's function notation with a list since this may be more natural to the readers of this work.
Let $\Nats^{\leq d}$ be the collection of all subsets of the naturals $K \subset \Nats$ with cardinality $|K| \leq d$.

We refer to indexed collections of \iid Uniform$[0,1]$ random variables as $U$-arrays.

\begin{prop}[\citet{Kallenberg1999-pj}]
\label{prop:piexas}
  Let $X$ be a random $d$-array in a Borel space $S$.
  Then $X$ is $\pi$-exchangeable iff there exists a measurable function $f:[0,1]^{2^d}\to S$ and a $U$-array $\xi$ with index set $\prod_{J\in\pi} \Nats^{\leq |J|}$ such that
  \begin{equation}
    X_k = f(\xi_{k_{\pi I}} : I \subset \{1,\ldots,d\}) \ \as, \quad k \in \Nats^d.
    \label{eq:piexas}
  \end{equation}
\end{prop}

We now extend this proposition to the case of an exchangeable database.
Again we state a useful lemma.

\begin{lemma}
  \label{lemma:copies-full-simple}
  Let $X_{ij} = f({U}_i, {V}_{ij}) \ \as \ i,j \in \Nats$ where $f$ is measurable and ${V}_{ij} \independent {V}_{ij'} \, \forall \, j \neq j'$.
  Suppose further that $X_{ij} = X_i \ \as$ for some collection of random variables $X_{i} \, \forall \, i,j \in \Nats$.
  Then there exists a measurable function $g$ such that $X_i = g({U}_i) \ \as$
\end{lemma}

\begin{proof}
  Conditional strong law of large numbers essentially \TBD{TBD}.
\end{proof}

Let $k^s \defas (k_i : i \in I_s)$ and let $\pi_s \defas \{J \cap I_s : J \in \pi\}$

\begin{thm}[almost sure functional representation for exchangeable databases]
  \label{thm:as-database}
  A database $(X^{r_j})_{j=1}^R$ is exchangeable iff there exist measurable functions $f^j : [0,1]^{2^{d_j}} \to S_j$ such that
  \begin{equation}
    X_{k^{s_j}}^{r_j} = f^j(\xi_{k_{\pi I}} : I \subset I_{s_j}) \ \as, \quad k \in \Nats^d, \ j \in \{1,\ldots,R\}.
  \end{equation}
\end{thm}

\begin{proof}
  It is simple to verify that this construction produces databases with the required symmetry properties to be exchangeable so we need only show that such a construction is guaranteed to exist by exchangeability.
  We proceed as before by embedding each array into one larger array
  \[
    R_{\bi} = (X^{r_j}_{\rho(\bi)} : j = 1,\dots,R) \quad \forall \, \bi \in \Nats^d
  \]
  which is $\pi$ exchangeable and thus by proposition~\ref{prop:piexas} there exists a measurable $g$ and $U$-array $\xi$ with index set $\prod_{J\in\pi} \Nats^{\leq |J|}$ such that
  \[
    R_{\bi} = g(\xi_{\bi_{\pi I}} : I \subset \{1,\ldots,d\}) \ \as, \quad \bi \in \Nats^d.
  \]
  We then repeatedly apply lemma~\ref{lemma:copies-full-simple} to remove the redundancy of this representation.
  For example, for some $k \notin I_{s_j}$ we have that there exists some measurable $h^j$ such that
  \[
    h^j(\xi_{\bi_{\pi I}} : I \subset \{1,\ldots,d\} \backslash k) = X^{r_j}_{\rho(\bi)} \ \as
  \]
  After repeated application we will find that there exists measureable $f^j$ such that
  \[
    f^j(\xi_{\bi_{\pi I}} : I \subset I_{s_j}) = X^{r_j}_{\rho(\bi)} \ \as
  \]
  and we are done.
\end{proof}

\subsection{Examples}

\begin{cor}
  Consider an exchangeable database with one object type, one unary relationship, and one binary relationship; denote the binary relationship by the array $X=(X_{i,j})_{i,j\in\Nats}$ and the unary relationship with the sequence $C=(C_i)_{i\in\Nats}$.
   Then there exist measurable functions $(F, G)$ and a collection of \iid Uniform$[0,1]$ random variables $U, (\AHvar_{i})_{i\in\Nats}, (\AHvar_{\{i,j\}})_{i,j\in\Nats}$ such that
   \[ 
     X_{ij} & = F(U, \AHvar_{i},\AHvar_{j}, \AHvar_{\{i,j\}}), \qquad \text{for } i,j,n\in\Nats, \\
     C_i & = G(U, \AHvar_{i}), \qquad \text{for } i,n\in\Nats,
    \]
almost surely.
\end{cor}

This is the Aldous--Hoover representation for a jointly exchangeable array and the de Finetti representation of an exchangeable sequence at the same time, with coupled uniform random variables.

\begin{cor}
  Consider an exchangeable database with two object types, one binary relation between two objects of the first type and a binary relation between objects of different types;  denote the first relation by the array $X=(X_{i,j})_{i,j\in\Nats}$ and the second by $Y=(Y_{i,k})_{i,k\in\Nats}$.
   Then there exists a pair of measurable functions $(F, G)$ and a collection of \iid Uniform$[0,1]$ random variables $U, (\AHvar_{i})_{i\in\Nats}, (\AHvaralt_{i})_{i\in\Nats}, (\AHvar_{\{i,j\}})_{i,j\in\Nats}, (W_{i,j})_{i,j\in\Nats}$ such that
   \[ 
     X_{ij} & = F(U,\AHvar_{i},\AHvar_{j},  \AHvar_{\{i,j\}}),  \qquad &\text{for } i,j\in\Nats, \\
     Y_{ik} & = G(U, \AHvar_{i}, \AHvaralt_{k}, W_{ik}), \qquad &\text{for } i,k\in\Nats,
    \]
almost surely.
\end{cor}

This is the Aldous--Hoover representation for a jointly exchangeable array and the Aldous--Hoover representation of a separately exchangeable array at the same time, but with coupled uniform random variables due to the shared objects underlying the data.

\begin{cor}
  Consider an exchangeable database with two object types, one binary relation between two objects of the first type and a ternary relation between two objects of the first type and one of the second type;  denote the first relation by the array $X=(X_{i,j})_{i,j\in\Nats}$ and the second by $Y=(Y_{i,j,k})_{i,j,k\in\Nats}$.
   Then there exists a pair of measurable functions $(F, G)$ and a collection of \iid Uniform$[0,1]$ random variables $U, (\AHvar_{i})_{i\in\Nats}, (\AHvaralt_{i})_{i\in\Nats}, (\AHvar_{\{i,j\}})_{i,j\in\Nats}, (W_{i,j})_{i,j\in\Nats} (Z_{\{i,j\}k})_{i,j,k\in\Nats}$ such that
   \[ 
     X_{ij} & = F(U,\AHvar_{i},\AHvar_{j},  \AHvar_{\{i,j\}}),  \qquad &\text{for } i,j\in\Nats, \\
     Y_{ijk} & = G(U, \AHvar_{i}, U_j \AHvaralt_{k}, \AHvar_{\{i,j\}}, W_{ik}, W_{jk}, Z_{\{i,j\},k}), \qquad &\text{for } i,j,k\in\Nats,
    \]
almost surely.
\end{cor}

This is the Aldous--Hoover representation for a jointly exchangeable array and the Kallenberg representation of a $\pi$-exchangeable array at the same time, but again with shared uniform random variables.

\section{A generic statistical model template}

In analogy to the work of \cite{Hoff2007-ja, Roy2009-ge, Lloyd2012-sb} on exchangeable arrays, theorem~\ref{thm:as-database} naturally inspires a generic generative model of exchangeable databases.
Each object of type $t$ in the database is associated with an \iid sample, $\AHvar_i^t$, from some distribution $\mathcal{U}$ \eg Uniform, Gaussian.
For each relation $r_1,\dotsc,r_R$ we sample a random function $F^j$ from some distribution $\mathcal{F}^j$, \eg Gaussian process, random (bi/tri/\ldots)linear functions.
We denote the evaluation of these functions at the corresponding values of $(\AHvar_i^t)$ by $W^j$.
$W^j$ can then be passed through a link function and distribution $L^j(\cdot)$ to model the observed value of the relation $r_j$.
\[
(\AHvar_i^t) & \simiid  \mathcal{U} \\
F^j & \sim  \mathcal{F}^j \\
W^j_{\bi} & \defas F^j(\AHvar^{s_j(1)}_{i_1},\cdots,\AHvar^{s_j(n)}_{i_n}) \\
X^{r_j}_{\bi} \given W & \sim  L^j(W^j_{\bi}) \qquad \text{independently across $j$ and $\bi$.}
\]

\begin{rem}[dependence between functions]
In general, the functions $F^j$ may be dependent.
However, the representation results presented in this chapter provide no guidance on the form of this dependence; stronger assumptions than exchangeability would have to be made.
In practice one may model the functions to be independent a priori at the risk of wasting statistical strength.
\end{rem}

\subsection{Deriving appropriate forms for discriminative models}

Consider a social network with side information on each user.
The natural generative model for such data inspired by the simple database representation result is
\[
  U_i & \simiid \mathcal{U} \\
  F & \sim \mathcal{F} \\
  G & \sim \mathcal{G} \\
  X_{ij} & \sim L^X(F(U_i, U_j)) \\
  C_{i} & \sim L^C(G(U_i))
\]
but in the situation where $C$ is fully observed and the task is to predict missing entries of $X$ it may be unnecessary to learn a model of $C$.
Indeed, if $C$ is assumed to be noiselessly observed, then we have $C_i = L^C(G(U_i))$ where $L^C(G(.))$ is a deterministic function.
We can then choose to model $X$ as follows
\[
  F'(U_i, U_j, C_i, C_j) & = F'(U_i, U_j, L^C(G(U_i)), L^C(G(U_j))) = F(U_i, U_j) \\
  X_{ij} & \sim L^X(F'(U_i, U_j, C_i, C_j)).
\]
Furthermore we could choose $F'$ to not depend on $U_i, U_j$ resulting in the model
\[
  X_{ij} & \sim L^X(F''(C_i, C_j))
\]
which is simply a regression model.

Indeed, the same logic can be applied to exchangeable sequences to derive more standard regression models.
Suppose that $(X_i, Y_i)$ is an exchangeable sequence.
By de Finetti's theorem we can model this as
\[
  U_i & \sim \mathcal{U} \\
  F & \sim \mathcal{F} \\
  G & \sim \mathcal{G} \\
  X_i & \sim L^X(F(U_i)) \\
  Y_i & \sim L^Y(G(U_i))
\]
and by similar arguments to those above, if we were to assume that $X$ was noiselessly observed we could model $Y$ as
\[
  Y_i & \sim L^Y(G(X_i))
\]
which is a standard regression model, or
\[
  Y_i & \sim L^Y(G(U_i, X_i))
\]
which combines latent variable modelling and regression.
An example of this hybrid model structure can be found in \cite{Wang2012-rc} but is otherwise surprisingly uncommon.

Now suppose we perfectly observe a binary relation; what can this tell us about modelling a related unary relation?
We now demonstrate how we could reconstruct an example model presented in \cite{Friedman1999-mo}.
They present a simple genetic model where one's maternal chromosome depends on your mother's maternal and paternal chromosomes and similarly for one's paternal chromosome.
In this example we have two binary relations, mother-of and father-of and two unary relations, maternal and paternal chromosomes.
We write this as $X_{ij} = 1 \iff$ person $i$ is the mother of person $j$ and $Y_{ij} = 1 \iff$ person $i$ is the father of person $j$ and the arrays elements take the value 0 otherwise.
Further let $M_i$ and $P_i$ be the maternal and paternal chromosomes of person $i$ respectively.
A potential form of a model for this data is
\[
  U_i & \sim \mathcal{U} \\
  F & \sim \mathcal{F} \\
  G & \sim \mathcal{G} \\
  H & \sim \mathcal{H} \\
  J & \sim \mathcal{J} \\
  X_{ij} & \sim L^X(F(U_i, U_j)) \\
  Y_{ij} & \sim L^Y(G(U_i, U_j)) \\
  M_i & \sim L^M(H(U_i)) \\
  P_i & \sim L^P(J(U_i))
\]
Applying similar arguments to before we can replace $U_i$ by $U_i'  \defas (U_i, V_i, M_i, P_i)$ where we have split the latent variable $U_i$ into $U_i$ and $V_i$ for convenience.
We could then define
\begin{align}
L^X(F(U_i',U_j')) &= 
  \begin{cases}
    1 & \textrm{if } (M_i, P_i) = U_j \\
    0 & \textrm{otherwise}  
  \end{cases}\\
L^Y(G(U_i',U_j')) &=
  \begin{cases}
    1 & \textrm{if } (M_i, P_i) = V_j \\
    0 & \textrm{otherwise}  
  \end{cases}
\end{align}
Performing inference in this model we would then find that in the posterior $U_i = (M_j, P_j)$ where person $j$ is the mother of person $i$ and similarly for $V_i$.
This would then allow the functions $H$ and $J$ to specify that the maternal chromosome of person $i$ depend probabilistically on the chromosomes of their mother and similarly for their paternal chromosome.
We have therefore shown how this particular probabilistic relational model can be cast in the form guaranteed to exist by the theorems presented in this chapter.
In principle, suitable prior distributions on the latent variables and functions could learn such a representation purely from data, although in this situation it is sensible to use prior knowledge.

However, the alert reader will have noticed that the functions $L^X(F(.,.))$ and $L^Y(G(.,.))$ defined above are almost everywhere zero.
This is exactly because the relations mother-of and father-of define sparse graphs with in-degrees of at most one.
As remarked in chapter~\ref{ch:networks}, any not almost everywhere zero representing function will imply density when modelling a graph.
The above exercise is certainly quite a contortion that is only clear when one knows the model one is aiming at.
We repeat that general representation results for sparse graphs that can usefully imply model structures are still unknown.

As before with the regression example, it may be wise to use models which use both observed and hidden variables within the representing functions.
Examples are again rare but this has been applied in \eg the movie recommendation context \citep[e.g.][]{Menon2011-ku}.\fTBD{To be expanded upon}

\subsection{Higher order dependencies}

So far we have only considered probabilistic models inspired by the simple array versions of exchangeability theorems.
Do the almost sure representation theorems, with their more detailed latent variable representations, tell us anything?
Consider the following dataset: we have a social network $X_{ij}$ and a ternary relation $Y_{ijk}$ that records if both person $i$ and person $j$ have been to location $k$.
The simple array inspired representation of this data is of the form
\[
  X_{ij} & \sim L^X(F(U_i, U_j)) \\
  Y_{ijk} & \sim L^Y(G(U_i, U_j, V_k))
\]
and in contrast the almost sure result would suggest a more elaborate model of the form
\[
  X_{ij} & \sim L^X(F(U_i, U_j, U_{\{ij\}})) \\
  Y_{ijk} & \sim L^Y(G(U_i, U_j, U_{\{ij\}}, V_k, W_{ik}, W_{jk}, Z_{\{ij\}k})).
\]
Now suppose that $X$ included information on the type of relations in the social network, and that people $i$ and $j$ were in a romantic relationship.
This knowledge would make it more likely for this couple to visit \eg restaurants typically frequented by couples.
In the almost sure representation this information could easily be transferred from $X$ to the modelling of $Y$ via the shared latent variable $U_{\{i,j\}}$.
In the simple array representation this knowledge would somehow have to be encoded in the latent variables $U_i$ and $U_j$ meaning that the problem of sharing this information is at least as hard as producing an effective generative model of which pairs of people are in a relationship\footnote{Presumably a problem that has been well studied by online dating services.}.

We are however unaware of any standard probabilistic models making use of this type of dependence.
This is most probably due to the potentially large computational barrier to storing and inferring the values of latent variables for each pair of objects.
There may however be use in this type of relationship on small datasets where one can afford relatively high computational costs to perform a more detailed analysis.

\subsection{A brief word about longitudinal data}

It is worth mentioning how the modelling paradigms presented here can be extended to longitudinal data (\ie time varying).
For example, consider longitudinal measurements of a social network $X_{ij}^t$.
Let $Y_{ij} \defas \{X_{ij}^t : t \in \mathcal{T}\}$ where $\mathcal{T}$ represents some period of time.
Then $Y_{ij}$ can be assumed to be exchangeable meaning that we can represent its distribution as
\[
  Y_{ij} = G(U_i, U_j)
\]
which in turn means
\[
  X_{ij}^t = G^t(U_i, U_j)
\]
or more conventionally
\[
  X_{ij}^t = F(U_i, U_j, t)
\]
meaning that we can represent the distribution of the time evolving social network with fixed latent variables for each node but a time varying representing function.
The form of the time varying function is completely general, but it could be constrained further by assumptions of continuity, Markov assumptions or Markov exchangeability for example.
It is more typical however to assume that the latent variables also evolve through time (this still produces an exchangeable distribution) with the representing function potentially static.
\TBD{
Reference Ryan Adams basketball work and Dunson's work on this.
}
It may be advantageous however to have fixed latent variables when one is jointly modelling both time evolving and static data.

\subsection{Prior work using models of this form}

\fTBD{Don't forget this early block model variant \cite{Hoffman_undated-ri}}

In section~\ref{sec:networks:related} it was demonstrated that many models of single 2-arrays fit the form of the generic model presented above.
In particular there are models that assume $F$ is linear \citep[e.g.][]{Hoff2007-ja, Meeds2007-gd, Salakhutdinov2008-zt, Yu2008-tz, Miller2009-wg}, that $F$ is Gaussian process distributed \citep[e.g.][]{Lawrence2009-za, Yan2011-lc, Lloyd2012-sb} and other non-linear forms for $F$ both parametric \citep[e.g.][]{Hoff2002-vy} and nonparametric \citep[e.g.][]{Roy2009-ge}.
In addition to this there has been a line of work that uses increasingly more expressive forms of the distribution $\mathcal{U}$ \citep[e.g.][]{Wang1987-jd, Nowicki2001-xm, Kemp2006-jt, Xu2006-uy, Meeds2007-gd, Miller2009-wg, Palla2012-ch}.

Many, but not all, of these models have been extended to model $d$-arrays.
A summary of models using linear forms of $F$ is given in \cite{Kolda2009-ba}; non-linear models include \cite{Xu2012-ub} \TBD{cite the latest inftucker stuff}.

For full databases, the literature is limited to clustering / block / latent class models \cite{Kemp2006-jt} \TBD{don't forget IHRM} and models using linear forms for the $F^r$ \citep[e.g.][]{Lippert2008-gg, Singh2008-cb, Singh2008-qw, Jimeng2009-rw, Acar2011-vg, Gallinari2011-ac, Nickel2011-pi, Acar2012-no, Ermis2012-gk, Shangguan2012-ga, Singh2012-jj, Acar2013-na, Andersen2013-rg, Yin2013-we}.

We should certainly expect to see new research using some of the more advanced forms proposed for networks being applied to higher order arrays or full databases.
However, rather than proposing yet more specific models it would be very interesting to see automated model building techniques applied to these domains, potentially combined with model forms inspired by probabilistic relational models.

\section{Discussion}

We have demonstrated how the concept of exchangeability can be applied to databases and used to derive a natural parameter space for statistical models of such data.
Identifying a parameter space is the first step in any statistical analysis, allowing either frequentist estimation of the parameters or Bayesian prior specification.
This concept is well established for exchangeable sequences where de Finetti's theorem applies.
For exchangeable arrays, the relevant representation theorems were presented by Aldous and Hoover \cite{Aldous1981-lg, Hoover1979-br} over 30 years ago but it is only recently that these results are being used to inspire probabilistic models \cite{Hoff2007-ja, Roy2009-ge, Lloyd2012-sb} and frequentist estimation procedures \cite{Kallenberg1999-pj, Choi2013-th, Wolfe2013-vs}.
We hope that this work will continue and be extended to the analysis of exchangeable databases.

%\subsection{Mention sparsity again}

%\TBD{This is really important to talk about at all times! Reference latest literature on this topic.}

\outbpdocument{
\bibliographystyle{plainnat}
\bibliography{references.bib}
}
